<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Realtime Questionnaire</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: Arial; max-width: 700px; margin: auto; padding: 20px; }
    .question { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; }
    button { margin-top: 5px; }
    input[type=password] { width: 200px; }
    input[type=text] { width: 100%; }
    pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>

<h1>Realtime Questionnaire</h1>

<!-- User Name -->
<div id="nameDiv">
  <input type="text" id="userName" placeholder="Enter your first name">
  <button onclick="startSurvey()">Start Survey</button>
</div>

<!-- EDIT LOGIN -->
<div id="login" style="margin-top:20px;">
  <h3>Edit Mode (Password required)</h3>
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<!-- EDIT PANEL -->
<div id="editor" style="display:none; margin-top:20px;">
  <h3>Add Question</h3>
  <input id="newQuestion" placeholder="Question text" style="width:100%;">
  <button onclick="addQuestion()">Add</button>
  <button onclick="resetVotes()">Reset Votes</button>
  <hr>
  <h3>All Answers (Per Person)</h3>
  <pre id="allAnswers"></pre>
</div>

<!-- QUESTIONS -->
<div id="questions"></div>

<script>
  // ðŸ”¥ YOUR FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyAezObxeL4XG0gFk9utDuuMKZH67BzVKuI",
    authDomain: "survey-tracker-e5f45.firebaseapp.com",
    projectId: "survey-tracker-e5f45",
    storageBucket: "survey-tracker-e5f45.firebasestorage.app",
    messagingSenderId: "343879125091",
    appId: "1:343879125091:web:720fd2d5228d0f1899d056",
    measurementId: "G-DJ0MF6EQ2T"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const questionsRef = db.ref("questions");
  const answersRef = db.ref("answers");

  const EDIT_PASSWORD = "hisinges1234";
  let editMode = false;
  let currentUser = "";

  function startSurvey() {
    const name = document.getElementById("userName").value.trim();
    if (!name) { alert("Please enter your first name."); return; }
    currentUser = name;
    document.getElementById("nameDiv").style.display = "none";
  }

  function login() {
    const input = document.getElementById("password").value;
    if (input === EDIT_PASSWORD) {
      editMode = true;
      document.getElementById("editor").style.display = "block";
      loadAllAnswers();
      alert("Edit mode enabled");
    } else {
      alert("Wrong password");
    }
    document.getElementById("password").value = "";
  }

  function addQuestion() {
    const text = document.getElementById("newQuestion").value;
    if (!text) return;
    questionsRef.push({
      text: text,
      answers: { never: 0, sometimes: 0, half: 0, almost: 0 },
      locked: false
    });
    document.getElementById("newQuestion").value = "";
  }

  function editQuestion(id) {
    const newText = prompt("Edit question text:");
    if (newText) questionsRef.child(id).update({ text: newText });
  }

  function deleteQuestion(id) {
    if (confirm("Are you sure you want to delete this question?")) {
      questionsRef.child(id).remove();
      answersRef.child(id).remove();
    }
  }

  function vote(id, type) {
    if (!currentUser) { alert("Please enter your name first."); return; }

    questionsRef.child(id).once("value", snap => {
      const q = snap.val();
      if (q.locked) { alert("Voting for this question is locked."); return; }

      answersRef.child(id).child(currentUser).once("value", snap2 => {
        if (snap2.exists()) {
          alert("You already answered this question.");
        } else {
          answersRef.child(id).child(currentUser).set(type);
          questionsRef.child(id).child("answers").child(type)
            .transaction(val => (val||0)+1);
        }
      });
    });
  }

  function resetVotes() {
    if (!editMode) return;
    if (!confirm("Reset votes so everyone can answer again?")) return;

    questionsRef.once("value", snap => {
      snap.forEach(q => {
        questionsRef.child(q.key).update({ locked: false });
      });
    });

    answersRef.remove().then(() => loadAllAnswers());
  }

  function loadAllAnswers() {
    answersRef.once("value", snap => {
      const data = snap.val() || {};
      document.getElementById("allAnswers").textContent = JSON.stringify(data, null, 2);
    });
  }

  questionsRef.on("value", snap => {
    const container = document.getElementById("questions");
    container.innerHTML = "";

    snap.forEach(q => {
      const data = q.val();
      const total = Object.values(data.answers).reduce((a,b)=>a+b,0)||1;

      let editBtns = "";
      if (editMode) {
        editBtns = `<br>
          <button onclick="editQuestion('${q.key}')">Edit Question</button>
          <button onclick="deleteQuestion('${q.key}')">Delete Question</button>`;
      }

      container.innerHTML += `
        <div class="question">
          <strong>${data.text}</strong><br><br>

          <button onclick="vote('${q.key}','never')">Never (${Math.round(data.answers.never/total*100)}%)</button><br>
          <button onclick="vote('${q.key}','sometimes')">Sometimes (${Math.round(data.answers.sometimes/total*100)}%)</button><br>
          <button onclick="vote('${q.key}','half')">Half the time (${Math.round(data.answers.half/total*100)}%)</button><br>
          <button onclick="vote('${q.key}','almost')">Almost always (${Math.round(data.answers.almost/total*100)}%)</button>

          ${editBtns}
        </div>
      `;
    });
  });
</script>

</body>
</html>
